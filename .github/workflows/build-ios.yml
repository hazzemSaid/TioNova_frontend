# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Packets Mobile â€” iOS Build for Appetize.io
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Triggers on pushes & PRs to main/develop.
# Builds an iOS Simulator .app bundle and zips it so it can be
# uploaded directly to Appetize.io â€” no signing needed!
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Build iOS (Appetize)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # allow manual trigger

concurrency:
  group: ios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ios:
    name: ğŸ Build iOS for Appetize
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Flutter SDK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      # â”€â”€ 3. Verify toolchain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Flutter doctor
        run: flutter doctor -v

      # â”€â”€ 4. Install dependencies & resolve conflicts â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get dependencies
        run: |
          flutter pub get
          flutter pub deps
      
      # â”€â”€ 4.1. Validate dependency resolution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check for dependency conflicts
        run: flutter pub deps --no-dev
        
      # â”€â”€ 4.2. Clean previous builds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Clean previous builds
        run: flutter clean

      # â”€â”€ 5. Install CocoaPods dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update || echo "No Podfile found â€“ skipping"
      
      # â”€â”€ 6. Re-install dependencies after CocoaPods â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Re-install Flutter dependencies 
        run: flutter pub get

      # â”€â”€ 7. Static analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: true

      # â”€â”€ 8. Run tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run tests
        run: flutter test
        continue-on-error: true

      # â”€â”€ 9. Build iOS Simulator app â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #    Appetize.io requires a Simulator build (.app zipped).
      #    This does NOT need any code-signing certificates.
      - name: Build iOS Simulator app
        run: flutter build ios --debug --simulator

      # â”€â”€ 10. Zip the .app for Appetize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Zip .app bundle for Appetize
        run: |
          cd build/ios/iphonesimulator
          zip -r Runner.app.zip Runner.app

      # â”€â”€ 11. Upload Appetize-ready artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload iOS Simulator build
        uses: actions/upload-artifact@v4
        with:
          name: packets-ios-appetize-${{ github.sha }}
          path: build/ios/iphonesimulator/Runner.app.zip
          retention-days: 14
          if-no-files-found: error

